<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Virtual Assessment 360¬∞ - Tour</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Fullscreen control CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <!-- Pannellum CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.css"/>

  <style>
    body { margin:0; font-family: Arial, sans-serif; height:100vh; display:flex; flex-direction:column; }
    header {
      background: linear-gradient(90deg, #0071bb, #00a859);
      color: #fff; text-align:center; padding:12px 16px; font-weight:700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    main { flex:1; display:flex; height: calc(100vh - 56px); position:relative; }

    #panorama { width:50%; height:100%; }
    #map { width:50%; height:100%; }

    .controls-topright {
      position: absolute;
      top: 10px;
      right: 10px;
      display:flex;
      gap:8px;
      z-index:1600;
      align-items:center;
      pointer-events: none;
    }
    .controls-topright > .btn {
      pointer-events: auto;
      background: #fff;
      border:1px solid #ccc;
      border-radius:6px;
      padding:6px 10px;
      font-size:14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      cursor:pointer;
    }

    .legend {
      position: absolute;
      top: 90px;
      right: 10px;
      z-index:1500;
      background:#fff;
      border-radius:8px;
      padding:10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      max-width:320px;
      display:none;
      font-size:14px;
    }
    .legend h4 { margin:0 0 6px 0; font-size:15px; }
    .legend hr { margin:8px 0; border:none; border-top:1px solid #eee; }
    .legend ul { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
    .legend li { cursor:pointer; padding:6px; border-radius:6px; color:#0563a3; }
    .legend li:hover { background:#f5f7fb; }

    @media (max-width: 768px) {
      main { flex-direction:column; }
      #panorama, #map { width:100%; height:50vh; }
      .legend {
        left: 6px;
        right: 6px;
        top: auto;
        bottom: 12px;
        max-width: none;
      }
      .legend ul { flex-direction:row; flex-wrap:wrap; gap:8px; }
      .legend li { background:#fff; color:#0563a3; border:1px solid #eee; padding:8px 10px; }
    }

    @media (min-width: 1024px) {
      /* khusus laptop/pc: daftar isi lebih turun agar tidak nutupi search */
      .controls-topright { top: 60px; }
      .legend { top: 140px; }
    }

    .pano-label {
      position:absolute;
      left:8px; bottom:8px;
      background: rgba(0,0,0,0.5);
      color:#fff; padding:6px 8px; border-radius:4px; font-weight:700;
      z-index:1200;
      font-size:13px;
    }
  </style>
</head>
<body>
  <header>Virtual Assessment 360¬∞ Untuk Proses Pengadaan Tanah - Zona Rokan</header>

  <main>
    <div id="panorama"></div>
    <div id="map"></div>

    <div class="controls-topright" id="myControls">
      <button id="legendBtn" class="btn">üìë Daftar Isi</button>
    </div>

    <div class="legend" id="legendPanel" aria-hidden="true">
      <h4>Layer</h4>
      <label><input type="checkbox" id="chkKecamatan"> Batas Kecamatan</label>
      <hr>
      <h4>Lokasi</h4>
      <ul id="locationList">
        <li data-key="a">A : Pipa Air Well 5C-58</li>
        <li data-key="b">B : BEKA25_0007</li>
        <li data-key="c">C : BEKA_#71</li>
        <li data-key="d">D : P_MINA25_0017HW</li>
        <li data-key="e">E : 9D-28E</li>
        <li data-key="f">F : KB 500</li>
      </ul>
    </div>

    <div class="pano-label" id="panoLabel">A</div>
  </main>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.js"></script>

  <script>
    var map = L.map('map').setView([0.7, 101.4], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.control.scale().addTo(map);
    L.control.fullscreen({ position: 'topleft' }).addTo(map);
    L.Control.geocoder({ position: 'topright' }).addTo(map);

    // geolocate button
    var userMarker;
    var locateBtn = L.control({ position: 'topleft' });
    locateBtn.onAdd = function () {
      var btn = L.DomUtil.create('button');
      btn.innerHTML = 'üìç';
      btn.title = 'Lokasi Saya';
      btn.style.width = '34px';
      btn.style.height = '34px';
      btn.style.fontSize = '16px';
      btn.style.borderRadius = '4px';
      btn.style.cursor = 'pointer';
      btn.onclick = function(){ map.locate({ setView:true, maxZoom:16 }); };
      return btn;
    };
    locateBtn.addTo(map);
    map.on('locationfound', function(e){
      if (!userMarker) {
        userMarker = L.marker(e.latlng).addTo(map).bindPopup("üìç Lokasi Anda").openPopup();
      } else {
        userMarker.setLatLng(e.latlng).openPopup();
      }
    });

    // pannellum
    var viewer = pannellum.viewer('panorama', {
      default: { firstScene: "sceneA", sceneFadeDuration: 600 },
      scenes: {
        "sceneA": { title: "A", type: "equirectangular", panorama: "foto360a.jpg", hfov:110 },
        "sceneB": { title: "B", type: "equirectangular", panorama: "foto360b.jpg", hfov:110 },
        "sceneC": { title: "C", type: "equirectangular", panorama: "foto360c.jpg", hfov:110 },
        "sceneD": { title: "D", type: "equirectangular", panorama: "foto360d.jpg", hfov:110 },
        "sceneE": { title: "E", type: "equirectangular", panorama: "foto360e.jpg", hfov:110 },
        "sceneF": { title: "F", type: "equirectangular", panorama: "foto360f.jpg", hfov:110 }
      }
    });
    var panoLabel = document.getElementById('panoLabel');
    viewer.on('load', function() {
      var curr = viewer.getScene();
      panoLabel.textContent = curr.replace('scene','').toUpperCase();
    });

    // marker data
    var markerData = {
      a: { coords: [0.777833, 101.400333], scene: 'sceneA', name: 'Pipa Air Well 5C-58' },
      b: { coords: [1.255722, 101.130778], scene: 'sceneB', name: 'BEKA25_0007' },
      c: { coords: [1.254083, 101.132306], scene: 'sceneC', name: 'BEKA_#71' },
      d: { coords: [0.844583, 101.385000], scene: 'sceneD', name: 'P_MINA25_0017HW' },
      e: { coords: [0.703194, 101.485667], scene: 'sceneE', name: '9D-28E' },
      f: { coords: [0.684500, 101.111500], scene: 'sceneF', name: 'KB 500' }
    };
    var markers = {};
    var iconDefault = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[28,28], iconAnchor:[14,28] });
    for (var k in markerData) {
      var d = markerData[k];
      var m = L.marker(d.coords, {icon: iconDefault}).addTo(map)
        .bindPopup("<b>" + d.name + "</b>");
      m.on('click', function(key=d.scene, label=k){ viewer.loadScene(key); panoLabel.textContent = label.toUpperCase(); });
      markers[k] = m;
    }

    // legend
    var legendBtn = document.getElementById('legendBtn');
    var legendPanel = document.getElementById('legendPanel');
    legendBtn.addEventListener('click', ()=>{ legendPanel.style.display = (legendPanel.style.display==='block'?'none':'block'); });
    document.querySelectorAll('#locationList li').forEach(function(li){
      li.addEventListener('click', function(){
        var key = this.dataset.key;
        var d = markerData[key];
        map.flyTo(d.coords, 16);
        markers[key].openPopup();
        viewer.loadScene(d.scene);
        panoLabel.textContent = key.toUpperCase();
        if (window.innerWidth<=768) legendPanel.style.display='none';
      });
    });
  </script>
</body>
</html>
